<link rel="import" href="../js/lib/polymer/polymer.html">
<link rel="import" href="d-picker-left.html">
<link rel="import" href="d-picker-right.html">
<link rel="import" href="d-picker-container.html">
<link rel="import" href="d-picker-show-date.html">
<dom-module id="d-picker">
  <template strip-whitespace>
    <style>
      :host {
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        width: 260px;
        display: flex;
        justify-content: space-between;
        overflow: hidden;
      }
    </style>
  </template>
  <script>
    Polymer({
      is: "d-picker",
      ready: function() {
        this.insertGotos();
        this.clickGoto();
        this.renderContainer(new Date());
        this.showSelectedDay();
        this.showContainerAgain();
      },
      insertGotos: function() {
        const left = document.createElement("d-picker-left");
        Polymer.dom(left).setAttribute("class", "goto");
        Polymer.dom(this.root).appendChild(left);
        const right = document.createElement("d-picker-right");
        Polymer.dom(right).setAttribute("class", "goto");
        Polymer.dom(this.root).appendChild(right);
      },
      clickGoto: function() {
        const _this = this;
        $(this).on("click", ".goto", function() {
          let container = _this.$$("d-picker-container");
          const ndate = new Date($(this).attr("goto"));
          let tl_vals;
          switch (this.tagName) {
            case 'D-PICKER-RIGHT':
              tl_vals = {out: 100}
              break;
            case 'D-PICKER-LEFT':
              tl_vals = {out: -100}
              break;
            default:

          }
          new TimelineLite()
            .to(container, 0.5, {x: tl_vals.out, opacity:0})
            .add(function() {
              _this.renderContainer(ndate);
              container = _this.$$("d-picker-container");
              TweenLite.from(container, 0.5, {opacity: 0});
            })
        });
      },
      setGotoAttr: function(d) {
        let goto_left  = d.getMonth() + '/1/' + d.getFullYear();
        let goto_right = (d.getMonth() + 2) + '/1/' + d.getFullYear();
        if(d.getMonth() == 0) {
          goto_left = '12/1/' + (d.getFullYear() - 1);
          goto_right = '2/1/' + d.getFullYear();
        } else if(d.getMonth() == 11) {
          goto_left = '11/1/' + d.getFullYear();
          goto_right = '1/1/' + (d.getFullYear() + 1);
        }
        Polymer.dom(this.$$("d-picker-left")).setAttribute("goto", goto_left);
        Polymer.dom(this.$$("d-picker-right")).setAttribute("goto", goto_right);
      },
      showContainerAgain: function() {
        const _this = this;
        $(this).on("click", "d-picker-show-date", function() {
          $(this).remove();
          const datestr = $(this).attr("datestr");
          _this.insertGotos();
          _this.renderContainer(new Date(datestr));
        });
      },
      showSelectedDay: function() {
        const _this = this;
        $(this).on("click", "d-picker-day", function() {
          const day = this.number;
          const month = _this.getMonthStr(this.month);
          const year = this.year;
          const container = _this.$$("d-picker-container");
          Polymer.dom(_this.root).removeChild(container);
          const gotos = Polymer.dom(_this.root).querySelectorAll(".goto");
          $.each(gotos, function(index, node) {
            Polymer.dom(_this.root).removeChild(node);
          });
          const show_date = document.createElement("d-picker-show-date");
          Polymer.dom(show_date).setAttribute("day", day);
          Polymer.dom(show_date).setAttribute("month", month);
          Polymer.dom(show_date).setAttribute("year", year);
          Polymer.dom(show_date).setAttribute("datestr", (this.month+1)+'/'+day+'/'+year);
          Polymer.dom(_this.root).appendChild(show_date);
        });
      },
      cleanContainers: function() {
        const container = this.$$("d-picker-container");
        if(container) {
          Polymer.dom(this.root).removeChild(container);
        }
      },
      renderContainer: function(date) {
        this.setGotoAttr(date);
        this.cleanContainers()
        const right = this.$$("d-picker-right");
        const container = document.createElement("d-picker-container");
        Polymer.dom(container).setAttribute("date", date);
        Polymer.dom(this.root).insertBefore(container, right);
      },
      getMonthStr: function(index) {
        const months = [
          'Enero','Febrero','Marzo','Abril','Mayo','Junio',
          'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
        ]
        return months[index];
      }
    })
  </script>
</dom-module>
