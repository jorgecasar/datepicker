<link rel="import" href="js/lib/polymer/polymer.html">
<link rel="import" href="dp-day.html">
<link rel="import" href="dp-day-empty.html">
<link rel="import" href="dp-day-labels.html">
<link rel="import" href="dp-month-year-label.html">
<dom-module id="dp-month">
  <template strip-whitespace>
    <style>
      :host {
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        width: 260px;
        display: flex;
        justify-content: space-between;
        overflow: hidden;
      }
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-flow: column;
        width: 168px;
      }
      #days {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      .go-to {
        display: flex;
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .go-to:hover {
        background-color: #f5f9fb;
      }
      .go-to.left {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
        z-index: 999;
      }
      .go-to.right {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
        z-index: 998;
      }
    </style>
    <div class="go-to left">
      <svg x="0px" y="0px" width="30px" height="30px" viewBox="0 0 48 48">
        <polygon points="15.808,24 26.301,13.507 29.973,17.179 23.161,24 29.977,30.816 26.302,34.492"/>
      </svg>
    </div>
    <div class="container">
      <dp-month-year-label month="Junio" year="2016"></dp-month-year-label>
      <dp-day-labels></dp-day-labels>
      <div id="days"></div>
    </div>
    <div class="go-to right">
      <svg x="0px" y="0px" width="30px" height="30px" viewBox="0 0 48 48">
        <polygon points="32.227,24 21.734,13.507 18.062,17.179 24.874,24 18.058,30.816 21.733,34.492"/>
      </svg>
    </div>
  </template>
  <script>
    Polymer({
      is: "dp-month",
      ready: function() {
        const this_root = this;
        this.renderCalendar(new Date());
        $(this).on("click", ".go-to", function() {
          let x_pos = $(this).hasClass("left")? -100 : 100
          const ndate_str = $(this).attr("date_str");
          new TimelineLite()
          .to(".container", 0.5, {
            x: x_pos,
            autoAlpha: 0,
            ease: Linear.easeNone
          })
          .set(".container", {x: 0, autoAlpha: 1}, "clean")
          .add(this_root.renderCalendar.bind(this_root, new Date(ndate_str)), "clean")
        });
      },
      renderCalendar: function(date) {
        const this_root = this;
        const days_container = this_root.$.days;
        $.each(Polymer.dom(days_container).childNodes, function(index, node) {
          Polymer.dom(days_container).removeChild(node);
        });
        const month = [
          'Enero','Febrero','Marzo','Abril','Mayo','Junio',
          'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
        ]
        const month_year_label = this_root.$$("dp-month-year-label");
        Polymer.dom(month_year_label).setAttribute("month", month[date.getMonth()]);
        Polymer.dom(month_year_label).setAttribute("year", date.getFullYear());
        for(let i = 0; i < date.getDay(); i++) {
          const dp_day_empty = document.createElement("dp-day-empty");
          Polymer.dom(days_container).appendChild(dp_day_empty);
        }
        const firstdate = new Date(
          (date.getMonth()+1) + '/1/' + date.getFullYear()
        );
        let currentdate = firstdate;
        let currentmonth = firstdate.getMonth();
        while (currentmonth == firstdate.getMonth()) {
          const dp_day = document.createElement("dp-day");
          Polymer.dom(dp_day).setAttribute("number", currentdate.getDate());
          Polymer.dom(days_container).appendChild(dp_day);
          currentdate = this_root.addDays(currentdate, 1);
          currentmonth = currentdate.getMonth();
        }
        this_root.setLeftRightDatesStr(date);
      },
      setLeftRightDatesStr: function(date) {
        const this_root = this;
        let left_date = date.getMonth() + '/1/' + date.getFullYear();
        let right_date = (date.getMonth() + 2) + '/1/' + date.getFullYear();
        if(date.getMonth() == 0) {
          left_date = '12/1/' + (date.getFullYear() - 1);
          right_date = '2/1/' + date.getFullYear();
        } else if(date.getMonth() == 11) {
          left_date = '11/1/' + date.getFullYear();
          right_date = '1/1/' + (date.getFullYear() + 1);
        }
        const goto_left = this_root.$$(".go-to.left");
        goto_left.setAttribute("date_str", left_date);
        const goto_right = this_root.$$(".go-to.right");
        goto_right.setAttribute("date_str", right_date);
      },
      addDays: function(date, days) {
        var result = new Date(date);
        result.setDate(date.getDate() + days);
        return result;
      }
    });
  </script>
</dom-module>
